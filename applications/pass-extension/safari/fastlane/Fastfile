PROJECT = "Proton Pass.xcodeproj"
BUILD_PATH = "build"
ENV["FASTLANE_ITC_TEAM_NAME"] = "Proton AG"
ENV["FASTLANE_APP_IDENTIFIER"] = "me.proton.pass.catalyst"
KEYCHAIN_NAME = "me.proton.pass.catalyst"
KEYCHAIN_PATH = File.expand_path("~/Library/Keychains/#{KEYCHAIN_NAME}-db")

def delete_keychain_if_exists
  delete_keychain(keychain_path: KEYCHAIN_PATH)
rescue => e
  UI.message("Keychain #{KEYCHAIN_NAME} not found or already deleted, skipping")
end

desc "Load App Store Connect API Key information to use in subsequent lanes"
lane :load_asc_api_key do
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY"]
    )
end

desc "Bump version number, optionally ask for input if version number not provided as argument"
lane :bump_version_number do |options|
  # Check if version number was passed as an argument
  version_number = options[:version_number]

  # If version number was not provided, prompt the user to enter it
  if version_number.nil?
    version_number = UI.input("Enter version number in semver format: ")
  end

  increment_version_number_in_xcodeproj(version_number: version_number)
end

desc "Bump build number, optionally ask for input if build number not provided as argument"
lane :bump_build_number do |options|
  # Check if version number was passed as an argument
  build_number = options[:build_number]

  # If build number was not provided, prompt the user to enter it
  if build.nil?
    build_number = UI.input("Enter build number: ")
  end

  increment_build_number_in_xcodeproj(build_number: "#{build_number}")
end

desc "Get latest TestFlight build number and bump build number by one"
lane :automatically_bump_build_number do
  load_asc_api_key
  api_key = lane_context[SharedValues::APP_STORE_CONNECT_API_KEY]

  # Get latest build number from TestFlight
  latest_build_number = latest_testflight_build_number(api_key: api_key, platform: "osx")
  new_build_number = latest_build_number + 1

  UI.message("Bumping to build number #{new_build_number}")
  increment_build_number_in_xcodeproj(build_number: "#{new_build_number}")
end

desc "Build and upload to App Store Connect then post a message to Slack"
lane :build_and_upload do
  load_asc_api_key
  api_key = lane_context[SharedValues::APP_STORE_CONNECT_API_KEY]

  keychain_password = ENV["KEYCHAIN_PASSWORD"]
  delete_keychain_if_exists
  create_keychain(
    name: KEYCHAIN_NAME,
    password: keychain_password,
    default_keychain: false,
    unlock: true,
    timeout: 3600,
    lock_when_sleeps: false,
    lock_after_timeout: false,
    add_to_search_list: true
  )

  import_certificate(
    certificate_path: "securefiles/Apple_distribution.p12",
    certificate_password: ENV["APPLE_DISTRIBUTION_CERT_PASSWORD"],
    keychain_path: KEYCHAIN_PATH,
    keychain_password: keychain_password
  )

  import_certificate(
    certificate_path: "securefiles/Installer_cert.p12",
    certificate_password: ENV["INSTALLER_CERT_PASSWORD"],
    keychain_path: KEYCHAIN_PATH,
    keychain_password: keychain_password
  )

   # Ensure our keychain is first in the search list so codesign finds the certs
  existing_keychains = `security list-keychains -d user`.split("\n").map { |k| k.strip.gsub('"', '') }
  search_list = [KEYCHAIN_PATH] + existing_keychains.reject { |k| k == KEYCHAIN_PATH }
  `security list-keychains -d user -s #{search_list.map { |k| %Q("#{k}") }.join(' ')}`
  UI.message("Keychain search list: #{`security list-keychains -d user`}")

  version_number = get_version_number(xcodeproj: PROJECT, target: "Proton Pass for Safari")
  build_number = get_build_number(xcodeproj: PROJECT)
  build_name = "#{version_number} (#{build_number})"
  output_directory = "#{BUILD_PATH}/#{build_name}"

  UI.success("⚒️  Making build #{build_name}")

  # Disable automatic signing and set distribution identity for CI
  update_code_signing_settings(
    use_automatic_signing: false,
    path: PROJECT,
    team_id: "2SB5Z68H26",
    code_sign_identity: "Apple Distribution",
    targets: ["Proton Pass for Safari", "Safari Extension"]
  )

  update_project_provisioning(
    xcodeproj: PROJECT,
    target_filter: "Proton Pass for Safari",
    profile: "securefiles/Proton_Pass_Catalyst.provisionprofile"
  )

  update_project_provisioning(
    xcodeproj: PROJECT,
    target_filter: "Safari Extension",
    profile: "securefiles/Proton_Pass_Catalyst_Safari_Extension.provisionprofile"
  )

  # Make the build
  build_mac_app(
        project: PROJECT,
        scheme: "Proton Pass",
        configuration: "Release",
        clean: true,
        output_directory: output_directory,
        xcargs: [
                  "-skipPackagePluginValidation",
                  "DEVELOPMENT_TEAM=2SB5Z68H26",
                  "CODE_SIGN_STYLE=Manual",
                  "CODE_SIGN_IDENTITY='Apple Distribution: Proton AG (2SB5Z68H26)'"
                ].join(" "),
	      use_system_scm: true,
        export_options: {
          method: "app-store",
          teamID: "2SB5Z68H26",
          signingStyle: "manual",
          installerSigningCertificate: "3rd Party Mac Developer Installer: Proton AG (2SB5Z68H26)",
          provisioningProfiles: {
            "me.proton.pass.catalyst" => "Proton Pass Catalyst",
            "me.proton.pass.catalyst.safari-extension" => "Proton Pass Catalyst Safari Extension"
        }
      }
    )
  
  delete_keychain_if_exists

  # Upload the build to TestFlight
  output_directory = "#{BUILD_PATH}/#{build_name}"
  pkg_path = output_directory + "/Proton Pass for Safari.pkg"
  upload_to_testflight(
      api_key: api_key,
      skip_submission: true,
      skip_waiting_for_build_processing: true,
      pkg: pkg_path)
  
  # Post message to Slack
  env = ENV["BUILD_ENV"]
  sh "../tools/new_build_slack_message.sh \":safari: #{build_name} (#{env})\""
end