// Content visibility optimization - Safari-safe
// Safari has known issues with content-visibility, so we use feature detection
// Also exclude elements with overflow to avoid rendering issues
@supports (content-visibility: auto) {
	.content-visibility-auto {
		content-visibility: auto;
		contain-intrinsic-size: auto 100px;
	}

	// Remove content-visibility from elements with overflow (Safari/compatibility issue)
	.markdown-table-wrapper,
	.markdown-rendering {
		content-visibility: unset;
		contain-intrinsic-size: unset;
	}
}

.markdown-rendering {
	font-size: 0.875rem;
	width: 100%;
	line-height: 1.5;
	gap: 0.75rem;
	color: var(--text-markdown);
	contain: layout style;
	word-break: break-word;

	/* Improve text rendering */
	text-rendering: optimizelegibility;
	-webkit-font-smoothing: antialiased;
	-moz-osx-font-smoothing: grayscale;

	h1 {
		font-size: 1.5rem;
		font-weight: bold;
		line-height: 1.3;
		margin-block: 1.5rem 0.75rem;
		margin-inline: 0;

		&:first-child {
			margin-block-start: 0;
		}
	}

	h2 {
		font-size: 1.25rem;
		font-weight: 600;
		line-height: 1.3;
		margin-block: 1.25rem 0.625rem;
		margin-inline: 0;

		&:first-child {
			margin-block-start: 0;
		}
	}

	h3 {
		font-size: 1.125rem;
		font-weight: 600;
		line-height: 1.4;
		margin-block: 1rem 0.5rem;
		margin-inline: 0;
	}

	h4 {
		font-size: 1rem;
		font-weight: 500;
		line-height: 1.4;
		margin-block: 0.875rem 0.375rem;
		margin-inline: 0;
	}

	p {
		margin-block: 0.625rem;
		margin-inline: 0;
		line-height: 1.5;

		h1 + &,
		h2 + &,
		h3 + &,
		h4 + & {
			margin-block-start: 0.5rem;
		}
	}

	hr {
		border: none;
		block-size: 1px;
		background-color: var(--border-weak);
		margin-block: 2rem;
		margin-inline: auto;
		inline-size: 60%;
		max-inline-size: 200px;
		opacity: 0.6;
	}

	ul,
	ol {
		margin-block: 0.75rem;
		margin-inline: 0;
		padding-inline-start: 1.5rem;

		li {
			margin-block: 0.125rem;
			margin-inline: 0;
			line-height: 1.5;

			&:first-child {
				margin-block-start: 0;
			}

			&:last-child {
				margin-block-end: 0;
			}

			ul,
			ol {
				margin-block: 0.25rem;
				margin-inline: 0;
			}
		}
	}

	blockquote {
		margin-block: 1.5rem;
		margin-inline: 0;
		padding-block: 1rem;
		padding-inline: 1.5rem;
		border-inline-start: 4px solid var(--primary);
		background-color: var(--background-weak);
		font-style: italic;

		p {
			margin: 0;
		}
	}

	table {
		inline-size: 100%;
		min-inline-size: 500px;
		border-collapse: separate;
		border-spacing: 0;
		margin: 0;
		background-color: var(--background-norm);
		font-size: 0.875rem;
		line-height: 1.5;
		table-layout: auto;
		border-radius: 0.5rem;

		// overflow: hidden;
		box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);

		@media (width <= 768px) {
			min-inline-size: 400px;
		}
	}

	thead {
		background-color: var(--background-weak);
	}

	th {
		padding-block: 1rem;
		padding-inline: 1.25rem;
		text-align: start;
		font-weight: 600;
		color: var(--text-norm);
		border-block-end: 1px solid var(--border-weak);
		white-space: nowrap;
		min-inline-size: 120px;
		max-inline-size: none;
		position: relative;
		font-size: 0.813rem;
		letter-spacing: 0.025em;
		overflow: hidden;
		text-overflow: ellipsis;

		&:not(:last-child) {
			border-inline-end: 1px solid var(--border-weak);
		}
	}

	td {
		padding-block: 1rem;
		padding-inline: 1.25rem;
		color: var(--text-norm);
		vertical-align: top;
		min-inline-size: 120px;
		max-inline-size: none;
		word-wrap: break-word;
		overflow-wrap: break-word;
		position: relative;

		&:not(:last-child) {
			border-inline-end: 1px solid var(--border-weak);
		}
	}

	tbody tr {
		transition: background-color 0.15s ease;

		&:hover {
			background-color: var(--background-weak);
		}

		&:not(:last-child) td {
			border-block-end: 1px solid var(--border-weak);
		}
	}

	tbody tr:nth-child(even) {
		background-color: rgb(0 0 0 / 0.01);

		&:hover {
			background-color: var(--background-weak);
		}
	}

	math {
		margin-block: 0.5rem;
	}

	@media (prefers-color-scheme: dark) {
		table {
			background-color: var(--background-norm);
		}

		thead {
			background-color: var(--background-strong);
		}

		tbody tr:nth-child(even) {
			background-color: rgb(255 255 255 / 0.02);
		}
	}

	pre {
		margin-block: 0.75rem;
		border-radius: 0.5rem;
		padding-block: 1.25rem;
		padding-inline: 1rem;
		inline-size: 100%;
		background-color: var(--markdown-pre-background);
		position: relative;
	}

	pre div {
		white-space: pre-wrap;
		word-break: break-word;
		margin: 0 !important;
		box-sizing: border-box;
		border-radius: 0.5em !important;
		font-family: 'SF Mono', Menlo, Monaco, Consolas, 'Liberation Mono', monospace;
		font-size: 0.98em;
		line-height: 1.6;
	}

	pre code {
		white-space: pre-wrap;
		word-break: break-word;
		color: var(--text-markdown);
	}
}

.markdown-table-wrapper {
	inline-size: 100%;
	overflow-x: auto;
	margin-block: 1.5rem;
	margin-inline: 0;
	border-radius: 0.5rem;
	border: 1px solid var(--border-weak);
	scroll-behavior: smooth;
	box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);
	background:
		linear-gradient(90deg, var(--background-norm) 30%, rgb(255 255 255 / 0)),
		linear-gradient(90deg, rgb(255 255 255 / 0), var(--background-norm) 70%) 0 100%,
		radial-gradient(farthest-side at 0 50%, rgb(0 0 0 / 0.1), rgb(0 0 0 / 0)),
		radial-gradient(farthest-side at 100% 50%, rgb(0 0 0 / 0.1), rgb(0 0 0 / 0)) 0 100%;
	background-repeat: no-repeat;
	background-color: var(--background-norm);
	background-size:
		40px 100%,
		40px 100%,
		14px 100%,
		14px 100%;
	background-attachment: local, local, scroll, scroll;
}

@media (width <= 768px) {
	.markdown-table-wrapper {
		margin-block: 0.75rem;
		margin-inline: 0;
		border-radius: 0;
		border-inline-start: none;
		border-inline-end: none;
	}

	.markdown-rendering {
		table {
			font-size: 0.813rem;
			min-inline-size: 600px;
		}

		th,
		td {
			padding-block: 0.875rem;
			padding-inline: 1rem;
			min-inline-size: 130px;
		}
	}
}

@media (width <= 480px) {
	.markdown-rendering {
		table {
			min-inline-size: 500px;
			font-size: 0.813rem;
		}

		th,
		td {
			padding-block: 0.75rem;
			padding-inline: 0.875rem;
			min-inline-size: 120px;
		}
	}
}
