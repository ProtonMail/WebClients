# Image Support in MessagePriv

## Context

Add inline image support to MessagePriv content field. Images generated by LLM will be embedded in message text using markdown syntax and rendered inline with preview/modal UI.

## Architecture

- **Storage**: Reuse existing Attachment system (no base64 in MessagePriv)
- **Format**: Markdown image syntax `![alt](attachment:{attachment-id})`
- **Serialization**: Existing msgpack binary serialization for attachments
- **Sync**: Existing attachment saga handles server sync
- **Rendering**: Custom react-markdown image component

## Key Files

### Types
- `applications/lumo/src/app/types.ts` - MessagePriv, AttachmentPriv definitions (lines 207-214)

### Serialization
- `applications/lumo/src/app/serialization.ts` - serializeAttachment/deserializeAttachment (lines 280-346)

### Rendering
- `applications/lumo/src/app/ui/components/LumoMarkdown/StreamingMarkdownRenderer.tsx` - Assistant message rendering
- `applications/lumo/src/app/ui/components/LumoMarkdown/LumoMarkdown.tsx` - User message rendering (static markdown)
- `applications/lumo/src/app/ui/components/LumoMarkdown/ProgressiveMarkdownRenderer.tsx` - Streaming block splitter

### Sync
- `applications/lumo/src/app/redux/sagas/attachments.ts` - pushAttachment saga (lines 277-359)

## Implementation Steps

### Phase 1: Type System
- [ ] Add `role?: 'user' | 'assistant'` field to AttachmentPriv type
- [ ] Update isAttachmentPriv type guard if needed
- [ ] Verify backward compatibility (defaults to 'user')

### Phase 2: Serialization
- [ ] Test serialize/deserialize with role='assistant' attachment
- [ ] Verify msgpack handles new field correctly
- [ ] Confirm encryption/decryption unchanged

### Phase 3: Basic Rendering
- [ ] Create InlineImageComponent component
  - Props: attachment, onLoad callback
  - Handles loading from IndexedDB if needed
  - Basic img display with maxWidth
- [ ] Add custom img renderer to StreamingMarkdownRenderer
  - Detect `attachment:{id}` URLs
  - Render InlineImageComponent
  - Handle missing attachment gracefully
- [ ] Test with hardcoded markdown in message content

### Phase 4: UI Enhancement
- [ ] Add click-to-expand modal to InlineImageComponent
  - Dark background overlay
  - Full-size image display
  - Click outside to close
- [ ] Add hover download button
  - Positioned over preview
  - Triggers download with proper filename
- [ ] Apply appropriate styling

### Phase 5: User Message Support
- [ ] Add same img renderer to LumoMarkdown component
- [ ] Verify parity between assistant/user rendering
- [ ] Test both message types

### Phase 6: Integration Testing
- [ ] Create test message with assistant-role attachment
- [ ] Verify attachment syncs to server via saga
- [ ] Confirm role='assistant' attachments filtered from user attachment UI
- [ ] Test message encryption/decryption with inline images

### Phase 7: Edge Cases
- [ ] Handle invalid attachment ID (nonexistent UUID)
  - Render placeholder or nothing
  - No console errors
- [ ] Handle deleted attachments
- [ ] Show loading state while fetching from IndexedDB
- [ ] Handle malformed markdown tokens gracefully

## Technical Notes

### Attachment Flow
1. Attachment created with role='assistant', added to Redux
2. Message created with attachment in `attachments[]` array
3. Message assigned spaceId when sent
4. pushAttachment saga auto-triggers (line 277 in attachments.ts)
5. Serializes, saves to IDB, POSTs to server

### Rendering Performance
- StreamingMarkdownRenderer throttles updates to 50ms during streaming
- ProgressiveMarkdownRenderer splits into complete/incomplete blocks
- InlineImageComponent should memoize to avoid re-renders
- Consider lazy loading images outside viewport

### Backward Compatibility
- Existing attachments without role field treated as 'user'
- Existing messages without inline images render unchanged
- Encryption AD (Additional Data) unchanged for messages
